generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String  @unique
  full_name  String
  avatar_url String?
  plan_type  String  @default("free")
  is_admin   Boolean @default(false)
  phone      String?
  password   String?

  cpf                      String?
  birth_date               String?
  has_disability           Boolean?
  race                     String?
  sexual_orientation       String?
  gender                   String?
  state                    String?
  city                     String?
  salary_expectation       String?
  has_cnh                  Boolean?
  instagram                String?
  facebook                 String?
  linkedin                 String?
  portfolio                String?
  professional_summary     String?   @db.Text
  career_goals             String?   @db.Text
  personality_profile      Json?
  personality_generated_at DateTime? @db.Timestamptz(6)

  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  resume            Resume?
  generated_resumes GeneratedResume[]
  chat              Chat[]
  chat_sessions     ChatSession[]
  ai_usage_logs     AiUsageLog[]

  @@index([email])
  @@index([plan_type])
  @@index([created_at(sort: Desc)])
  @@index([deleted_at])
  @@map("users")
}

model Template {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String   @unique
  slug          String   @unique
  description   String?
  thumbnail_url String?
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @updatedAt @db.Timestamptz(6)

  @@index([slug])
  @@index([is_active])
  @@map("templates")
}

model Resume {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id String @unique @db.Uuid

  experiences    Json @default("[]")
  skills         Json @default("[]")
  languages      Json @default("[]")
  educations     Json @default("[]")
  certifications Json @default("[]")

  completion_score Int       @default(0)
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at       DateTime? @db.Timestamptz(6)

  user              User?             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  generated_resumes GeneratedResume[]
  Chat              Chat[]
  chat_sessions     ChatSession[]

  @@index([user_id, updated_at(sort: Desc)])
  @@index([deleted_at])
  @@map("resume")
}

model GeneratedResume {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String    @db.Uuid
  resumeId        String    @db.Uuid
  session_id      String?   @db.Uuid
  title           String
  job_description String?   @db.Text
  file_url        String?
  is_published    Boolean   @default(false)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at      DateTime? @db.Timestamptz(6)

  user   User   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([user_id, created_at(sort: Desc)])
  @@index([resumeId])
  @@index([session_id])
  @@index([deleted_at])
  @@map("generated_resumes")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum MessageContentType {
  TEXT
  PDF_ATTACHMENT
  JOB_DESCRIPTION
  RESUME_ANALYSIS
  OPTIMIZATION_RESULT
}

model Message {
  id          String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chat_id     String             @db.Uuid
  role        MessageRole        @default(USER)
  messageType MessageContentType @default(TEXT)
  content     String             @db.Text
  pdf_url     String?            @db.Text
  citations   Json?
  metadata    Json?
  tokens_used Int?
  model       String?
  created_at  DateTime           @default(now()) @db.Timestamptz(6)
  updated_at  DateTime           @default(now()) @updatedAt @db.Timestamptz(6)

  chat Chat @relation("ChatMessages", fields: [chat_id], references: [id], onDelete: Cascade)

  @@index([chat_id, created_at(sort: Desc)])
  @@map("message")
}

model Chat {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String?   @db.Uuid
  resume_id       String?   @db.Uuid
  session_id      String?   @unique @db.Uuid
  title           String    @default("Nova Conversa")
  messages        Message[] @relation("ChatMessages")
  message_count   Int       @default(0)
  last_message_at DateTime  @default(now()) @db.Timestamptz(6)
  context_data    Json?
  last_error      String?   @db.Text
  total_tokens    Int       @default(0)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at      DateTime? @db.Timestamptz(6)

  user        User?         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  resume      Resume?       @relation(fields: [resume_id], references: [id], onDelete: Cascade)
  ChatSession ChatSession[]

  @@index([resume_id, last_message_at(sort: Desc)])
  @@index([user_id, last_message_at(sort: Desc)])
  @@index([session_id])
  @@index([deleted_at])
  @@map("resume_sessions")
}

model ChatSession {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id           String    @unique @db.Uuid
  user_id              String?   @db.Uuid
  chat_id              String?   @db.Uuid
  resume_data          Json?
  original_resume_data Json?
  is_anonymous         Boolean   @default(true)
  converted_at         DateTime? @db.Timestamptz(6)
  source               String?   @default("web")
  expires_at           DateTime  @db.Timestamptz(6)
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @updatedAt @db.Timestamptz(6)

  user     User?   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  chat     Chat?   @relation(fields: [chat_id], references: [id], onDelete: Cascade)
  Resume   Resume? @relation(fields: [resumeId], references: [id])
  resumeId String? @db.Uuid

  @@index([session_id])
  @@index([user_id])
  @@index([chat_id])
  @@index([expires_at])
  @@index([is_anonymous, created_at(sort: Desc)])
  @@index([converted_at])
  @@map("chat_sessions")
}

model AiUsageLog {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String   @db.Uuid
  action_type   String // "conversation", "resume_optimization", "pdf_generation"
  tokens_used   Int      @default(0)
  cost_cents    Int      @default(0)
  success       Boolean  @default(true)
  error_message String?
  metadata      Json     @default("{}")
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at(sort: Desc)])
  @@index([action_type, created_at(sort: Desc)])
  @@index([success])
  @@map("ai_usage_logs")
}
